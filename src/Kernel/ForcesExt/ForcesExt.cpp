#include <ForcesExt.h>
#include <common.cuh>
/*****************************************************************************************************/
/*****************************************************************************************************/
ForcesExt::ForcesExt()
{
	forces.clear();
}
/*****************************************************************************************************/
ForcesExt::~ForcesExt()
{
	for(uint i=0;i<forces.size();i++)
		delete(forces[i]);
	forces.clear();
}
/*****************************************************************************************************/
/*****************************************************************************************************/
ForceExt* ForcesExt::getForce(unsigned int i)
{
	assert(i<forces.size());
	return forces[i];
}
/*****************************************************************************************************/
vector<ForceExt*> ForcesExt::getForces()
{
	return forces;
}
/*****************************************************************************************************/
unsigned int ForcesExt::getNbForces()
{
	return forces.size();
}
/*****************************************************************************************************/
/*****************************************************************************************************/
void ForcesExt::setForce(ForceExt *F, unsigned int i)
{
	assert(i<forces.size());
	forces[i] = F;
}
/*****************************************************************************************************/
/*****************************************************************************************************/
void ForcesExt::addForce(ForceExt *F)
{
	forces.push_back(F);
}
/*****************************************************************************************************/
/*****************************************************************************************************/
void ForcesExt::_initialize(uint nbBodies)
{
       // initialize forces accumulator buffer and store it in GPU
	unsigned int memSize = sizeof(double) * 3 * nbBodies;
	allocateArray((void**)&m_F, memSize);
}
/*****************************************************************************************************/
void ForcesExt::init(uint nbBodies)
{
	double* F = new double[3*nbBodies];
	#pragma omp parallel for
	for(uint i=0;i<nbBodies;i++){
		F[i*3] = 0;
		F[i*3+1] = 0;
		F[i*3+2] = 0;
	}
	copyArrayToDevice(m_F,F,0,sizeof(double)*3*nbBodies);
	delete[] F;
}
/*****************************************************************************************************/
void ForcesExt::_finalize()
{
	freeArray(m_F); 
}
/*****************************************************************************************************/
/*****************************************************************************************************/
void ForcesExt::evaluate(double* pos, double* acummForce, double* mass, uint nbBodies)
{
	for(uint i=0;i<forces.size();i++)
		forces[i]->evaluate(pos,acummForce,mass,nbBodies);
}
/*****************************************************************************************************/
/*****************************************************************************************************/
